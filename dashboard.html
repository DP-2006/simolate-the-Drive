{% load static %}
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Manager Pro</title>
    <style>
        :root {
            --primary-color: #4a90e2;
            --bg-color: #f4f7f6;
            --panel-bg: #ffffff;
            --text-color: #333;
            --border-color: #e0e0e0;
            --danger-color: #e74c3c;
            --success-color: #2ecc71;
            
            --font-size: {{ settings.font_size }}px;
            --menu-width: {{ settings.menu_size }}px;
            --btn-height: {{ settings.button_size }}px;
        }

        * { box-sizing: border-box; }
        
        body {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: var(--font-size);
            height: 100vh;
            overflow: hidden;
            display: flex;
        }

        /* --- Ø³Ù…Øª Ø±Ø§Ø³Øª: ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ùˆ Ø¢Ù¾Ù„ÙˆØ¯ --- */
        .sidebar {
            width: var(--menu-width);
            background-color: var(--panel-bg);
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            padding: 15px;
            transition: width 0.3s;
            z-index: 10;
        }

        .sidebar-header {
            font-weight: bold;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .control-group {
            margin-bottom: 20px;
            background: #f9f9f9;
            padding: 10px;
            border-radius: 8px;
        }

        .control-label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9em;
            color: #666;
        }

        input[type="range"] { width: 100%; }

        .btn {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: #357abd; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--border-color); color: #555; }
        .btn:disabled { background-color: #ccc; cursor: not-allowed; }

        /* --- ÙˆØ³Ø·: ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù¾Ù„ÙˆØ¯ --- */
        .upload-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow: hidden;
            border-left: 1px solid var(--border-color);
            border-right: 1px solid var(--border-color);
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            background: var(--panel-bg);
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .file-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            overflow-y: auto;
            padding: 10px;
            border: 2px dashed var(--border-color);
            border-radius: 10px;
            background: #fafafa;
            flex: 1;
        }

        .file-item {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px;
            text-align: center;
            cursor: pointer;
            position: relative;
            transition: 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100px;
        }

        .file-item:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .file-item.selected { background-color: #e6f7ff; border-color: var(--primary-color); }
        
        .file-icon { font-size: 2em; margin-bottom: 5px; }
        .file-name { font-size: 0.75em; word-break: break-all; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; width: 100%; }
        .delete-btn { position: absolute; top: 2px; left: 2px; background: var(--danger-color); color: white; border: none; border-radius: 50%; width: 18px; height: 18px; font-size: 10px; cursor: pointer; display: none; }
        .file-item:hover .delete-btn { display: block; }

        /* --- Ø³Ù…Øª Ú†Ù¾: ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù…Ù† (Google Drive Style) --- */
        .my-files-panel {
            width: 300px; /* Ø¹Ø±Ø¶ Ø«Ø§Ø¨Øª Ø¨Ø±Ø§ÛŒ Ù„ÛŒØ³Øª ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ */
            background-color: var(--panel-bg);
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border-color);
        }

        .my-files-header {
            padding: 15px;
            background: #f0f2f5;
            border-bottom: 1px solid var(--border-color);
            font-weight: bold;
        }

        .my-files-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .db-file-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: 0.2s;
        }

        .db-file-item:hover { background-color: #f9f9f9; }
        .db-file-icon { font-size: 1.5em; margin-left: 10px; }
        .db-file-info { flex: 1; overflow: hidden; }
        .db-file-name { font-size: 0.9em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .db-file-date { font-size: 0.75em; color: #888; }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 100; }
        .modal-content { background: white; padding: 20px; border-radius: 10px; width: 300px; }
        .modal input { width: 100%; padding: 8px; margin: 10px 0; }

    </style>
</head>
<body>

    <!-- Ø³Ù…Øª Ø±Ø§Ø³Øª: ØªÙ†Ø¸ÛŒÙ…Ø§Øª -->
    <div class="sidebar">
        <div class="sidebar-header">
            <span>ØªÙ†Ø¸ÛŒÙ…Ø§Øª</span>
            <button onclick="resetSettings()" style="background:none; border:none; cursor:pointer; font-size:1.2em;" title="Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ">â†º</button>
        </div>

        <div class="control-group">
            <label class="control-label">Ø§Ù†Ø¯Ø§Ø²Ù‡ ÙÙˆÙ†Øª</label>
            <input type="range" min="12" max="24" value="{{ settings.font_size }}" oninput="updateStyle('fontSize', this.value + 'px')">
        </div>

        <div class="control-group">
            <label class="control-label">Ø¹Ø±Ø¶ Ù…Ù†Ùˆ</label>
            <input type="range" min="150" max="400" value="{{ settings.menu_size }}" oninput="updateStyle('menuWidth', this.value + 'px')">
        </div>

        <div class="control-group">
            <label class="control-label">Ø§Ù†Ø¯Ø§Ø²Ù‡ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§</label>
            <input type="range" min="30" max="60" value="{{ settings.button_size }}" oninput="updateStyle('btnHeight', this.value + 'px')">
        </div>

        <hr style="width:100%; border:0; border-top:1px solid #eee; margin: 20px 0;">

        <!-- Ø¯Ú©Ù…Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ù¾ÙˆØ´Ù‡ Ø¨Ø§ Ù‚Ø§Ø¨Ù„ÛŒØª Ú†Ù†Ø¯Ú¯Ø§Ù†Ù‡ -->
        <button class="btn btn-primary" onclick="document.getElementById('folderInput').click()">
            ğŸ“‚ Ø§Ù†ØªØ®Ø§Ø¨ Ù¾ÙˆØ´Ù‡/ÙØ§ÛŒÙ„ (Ú†Ù†Ø¯Ú¯Ø§Ù†Ù‡)
        </button>
        
        <button class="btn btn-success" id="sendBtn" onclick="uploadFiles()" disabled>
            ğŸš€ Ø§Ø±Ø³Ø§Ù„ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§
        </button>
        
        <button class="btn btn-outline" onclick="openCreateModal()">
            â• Ø³Ø§Ø®Øª ÙØ§ÛŒÙ„ / Ù¾ÙˆØ´Ù‡
        </button>
        
        <!-- ÙÙ‚Ø· Ø§Ø¯Ù…ÛŒÙ† Ù„ÛŒÙ†Ú© Ø±Ø§ Ù…ÛŒâ€ŒØ¨ÛŒÙ†Ø¯ -->
        {% if user.is_staff %}
        <a href="/admin-panel/" class="btn btn-danger" style="text-decoration:none; margin-top:auto;">
            ğŸ›¡ï¸ Ù¾Ù†Ù„ Ø§Ø¯Ù…ÛŒÙ†
        </a>
        {% endif %}

        <button class="btn btn-outline" onclick="window.location.href='/logout/'" style="margin-top: 10px; color: var(--danger-color); border-color: var(--danger-color);">
            Ø®Ø±ÙˆØ¬
        </button>
    </div>

    <!-- ÙˆØ³Ø·: Ø¢Ù¾Ù„ÙˆØ¯ -->
    <div class="upload-area">
        <div class="top-bar">
            <span id="currentPath">Ù…Ø³ÛŒØ±: Ù‡ÛŒÚ† Ù¾ÙˆØ´Ù‡â€ŒØ§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡</span>
            <span id="fileCount">0 ÙØ§ÛŒÙ„ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡</span>
        </div>

        <div class="file-grid" id="fileGrid" ondrop="dropHandler(event)" ondragover="dragOverHandler(event)">
            <div style="grid-column: 1/-1; text-align: center; color: #999; margin-top: 50px;">
                ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ú©Ø´ÛŒØ¯ ÛŒØ§ Ø§Ø² Ø¯Ú©Ù…Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯
            </div>
        </div>
    </div>

    <!-- Ø³Ù…Øª Ú†Ù¾: ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù…Ù† (Ø§Ø² Ø¯ÛŒØªØ§Ø¨ÛŒØ³) -->
    <div class="my-files-panel">
        <div class="my-files-header">ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù…Ù† (Drive)</div>
        <div class="my-files-list" id="dbFileList">
            {% for file in my_files %}
            <div class="db-file-item" onclick="previewDbFile('{{ file.file.url }}')">
                <div class="db-file-icon">
                    {% if '.png' in file.file.name or '.jpg' in file.file.name or '.jpeg' in file.file.name %}ğŸ–¼ï¸
                    {% elif '.pdf' in file.file.name %}ğŸ“•
                    {% elif '.mp4' in file.file.name %}ğŸ¥
                    {% else %}ğŸ“„{% endif %}
                </div>
                <div class="db-file-info">
                    <div class="db-file-name">{{ file.file.name|slice:"15:" }}</div>
                    <div class="db-file-date">{{ file.uploaded_at|date:"m/d H:i" }}</div>
                </div>
            </div>
            {% empty %}
            <div style="padding:20px; text-align:center; color:#999; font-size:0.8em;">Ù‡Ù†ÙˆØ² ÙØ§ÛŒÙ„ÛŒ Ø¢Ù¾Ù„ÙˆØ¯ Ù†Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯</div>
            {% endfor %}
        </div>
    </div>

    <!-- ÙˆØ±ÙˆØ¯ÛŒ Ù…Ø®ÙÛŒ -->
    <!-- multiple Ùˆ webkitdirectory Ø¨Ø±Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ú†Ù†Ø¯ Ù¾ÙˆØ´Ù‡ -->
    <input type="file" id="folderInput" class="hidden-input" webkitdirectory directory multiple onchange="handleFiles(this.files)">

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø³Ø§Ø®Øª ÙØ§ÛŒÙ„/Ù¾ÙˆØ´Ù‡ -->
    <div id="createModal" class="modal">
        <div class="modal-content">
            <h3>Ø³Ø§Ø®Øª Ø¬Ø¯ÛŒØ¯</h3>
            <input type="text" id="newItemName" placeholder="Ù†Ø§Ù… ÙØ§ÛŒÙ„ ÛŒØ§ Ù¾ÙˆØ´Ù‡">
            <div style="display:flex; gap:10px;">
                <button class="btn btn-primary" onclick="createItem('file')">ÙØ§ÛŒÙ„</button>
                <button class="btn btn-primary" onclick="createItem('folder')">Ù¾ÙˆØ´Ù‡</button>
                <button class="btn btn-outline" onclick="closeModal()">Ù„ØºÙˆ</button>
            </div>
        </div>
    </div>

    <script>
        let selectedFiles = [];
        let currentFolderName = '';

        // --- ØªÙ†Ø¸ÛŒÙ…Ø§Øª ---
        function updateStyle(type, value) {
            const root = document.documentElement;
            if(type === 'fontSize') root.style.setProperty('--font-size', value);
            if(type === 'menuWidth') root.style.setProperty('--menu-width', value);
            if(type === 'btnHeight') root.style.setProperty('--btn-height', value);
            saveSettingsToServer();
        }

        async function saveSettingsToServer() {
            const root = document.documentElement;
            const style = getComputedStyle(root);
            const fs = parseInt(style.getPropertyValue('--font-size')) || 14;
            const ms = parseInt(style.getPropertyValue('--menu-width')) || 200;
            const bs = parseInt(style.getPropertyValue('--btn-height')) || 40;

            await fetch('/api/settings/', {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken')},
                body: JSON.stringify({font_size: fs, menu_size: ms, button_size: bs})
            });
        }

        function resetSettings() {
            if(confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')) {
                updateStyle('fontSize', '14px');
                updateStyle('menuWidth', '200px');
                updateStyle('btnHeight', '40px');
                document.querySelectorAll('input[type="range"]').forEach(input => {
                   if(input.getAttribute('oninput').includes('fontSize')) input.value = 14;
                   if(input.getAttribute('oninput').includes('menuWidth')) input.value = 200;
                   if(input.getAttribute('oninput').includes('btnHeight')) input.value = 40;
                });
            }
        }

        // --- Ù…Ø¯ÛŒØ±ÛŒØª ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ ---
        function handleFiles(files) {
            if (!files.length) return;
            
            const firstFile = files[0];
            if (firstFile.webkitRelativePath) {
                const pathParts = firstFile.webkitRelativePath.split('/');
                currentFolderName = pathParts[0];
                document.getElementById('currentPath').textContent = `Ù¾ÙˆØ´Ù‡: ${currentFolderName}`;
            } else {
                currentFolderName = 'Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ø³ØªÛŒ';
                document.getElementById('currentPath').textContent = `ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡`;
            }

            Array.from(files).forEach(file => {
                if (file.name.toLowerCase().endsWith('.exe')) {
                    alert(`ÙØ§ÛŒÙ„ ${file.name} Ù…Ø¬Ø§Ø² Ù†ÛŒØ³Øª.`);
                    return;
                }
                if (!selectedFiles.some(f => f.name === file.name && f.size === file.size)) {
                    selectedFiles.push(file);
                    addFileToGrid(file);
                }
            });
            updateUI();
        }

        function addFileToGrid(file) {
            const grid = document.getElementById('fileGrid');
            if (grid.innerText.includes('ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ú©Ø´ÛŒØ¯')) grid.innerHTML = '';

            const div = document.createElement('div');
            div.className = 'file-item';
            div.onclick = (e) => toggleSelect(e, div);
            
            let icon = 'ğŸ“„';
            if (file.type.startsWith('image/')) icon = 'ğŸ–¼ï¸';
            else if (file.type.startsWith('video/')) icon = 'ğŸ¥';

            div.innerHTML = `
                <button class="delete-btn" onclick="removeFile(event, '${file.name}')">Ã—</button>
                <div class="file-icon">${icon}</div>
                <div class="file-name">${file.name}</div>
            `;
            grid.appendChild(div);
        }

        function toggleSelect(e, div) {
            if (e.target.classList.contains('delete-btn')) return;
            div.classList.toggle('selected');
            updateUI();
        }

        function removeFile(e, fileName) {
            e.stopPropagation();
            selectedFiles = selectedFiles.filter(f => f.name !== fileName);
            renderGrid();
            updateUI();
        }

        function renderGrid() {
            const grid = document.getElementById('fileGrid');
            grid.innerHTML = '';
            if (selectedFiles.length === 0) {
                 grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #999; margin-top: 50px;">ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ú©Ø´ÛŒØ¯ ÛŒØ§ Ø§Ø² Ø¯Ú©Ù…Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯</div>';
                 return;
            }
            selectedFiles.forEach(file => addFileToGrid(file));
        }

        function updateUI() {
            const count = selectedFiles.length;
            document.getElementById('fileCount').textContent = `${count} ÙØ§ÛŒÙ„ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø±Ø³Ø§Ù„`;
            document.getElementById('sendBtn').disabled = count === 0;
        }

        // --- Drag & Drop ---
        function dragOverHandler(ev) {
            ev.preventDefault();
            ev.currentTarget.style.borderColor = 'var(--primary-color)';
        }
        function dropHandler(ev) {
            ev.preventDefault();
            ev.currentTarget.style.borderColor = 'var(--border-color)';
            if (ev.dataTransfer.items) {
                [...ev.dataTransfer.items].forEach((item) => {
                    if (item.kind === 'file') handleFiles([item.getAsFile()]);
                });
            } else {
                handleFiles(ev.dataTransfer.files);
            }
        }

        // --- Ø¢Ù¾Ù„ÙˆØ¯ ---
        async function uploadFiles() {
            if (selectedFiles.length === 0) return;
            const formData = new FormData();
            selectedFiles.forEach(file => formData.append('files', file));
            formData.append('folder_name', currentFolderName);

            const btn = document.getElementById('sendBtn');
            btn.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„...';
            btn.disabled = true;

            try {
                const res = await fetch('/api/upload/', {
                    method: 'POST',
                    body: formData,
                    headers: {'X-CSRFToken': getCookie('csrftoken')}
                });
                const data = await res.json();
                alert(data.msg);
                if(data.success) {
                    selectedFiles = [];
                    renderGrid();
                    updateUI();
                    location.reload(); // Ø±ÙØ±Ø´ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø¯Ø± Ù„ÛŒØ³Øª Ø³Ù…Øª Ú†Ù¾
                }
            } catch (err) {
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø·');
            } finally {
                btn.textContent = 'ğŸš€ Ø§Ø±Ø³Ø§Ù„ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§';
                btn.disabled = false;
            }
        }

        // --- Ø³Ø§Ø®Øª ÙØ§ÛŒÙ„/Ù¾ÙˆØ´Ù‡ ---
        function openCreateModal() { document.getElementById('createModal').style.display = 'flex'; }
        function closeModal() { document.getElementById('createModal').style.display = 'none'; }
        function createItem(type) {
            const name = document.getElementById('newItemName').value;
            if(!name) return alert('Ù†Ø§Ù… Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
            alert(`${type === 'folder' ? 'Ù¾ÙˆØ´Ù‡' : 'ÙØ§ÛŒÙ„'} "${name}" Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯ (Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ)`);
            closeModal();
        }

        // --- Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ ÙØ§ÛŒÙ„ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ ---
        function previewDbFile(url) {
            window.open(url, '_blank');
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
</body>
</html>